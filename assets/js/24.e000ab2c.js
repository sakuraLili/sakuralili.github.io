(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{433:function(t,s,n){t.exports=n.p+"assets/img/01.46ad5821.png"},434:function(t,s,n){t.exports=n.p+"assets/img/02.386cd331.png"},435:function(t,s,n){t.exports=n.p+"assets/img/03.e69102a4.jpg"},547:function(t,s,n){"use strict";n.r(s);var a=n(5),e=Object(a.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("注意区分：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("nodejs")]),t._v("的"),s("code",[t._v("event")]),t._v("是基于"),s("code",[t._v("libuv")]),t._v("，而浏览器的"),s("code",[t._v("event loop")]),t._v("则在"),s("a",{attrs:{href:"https://www.w3.org/TR/html5/webappapis.html#event-loops",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("html5")]),t._v("的规范"),s("OutboundLink")],1),t._v("中明确定义")]),t._v(" "),s("li",[s("code",[t._v("libuv")]),t._v("已经对"),s("code",[t._v("event loop")]),t._v("作出了实现，而"),s("code",[t._v("html5")]),t._v("规范中只是定义了浏览器中"),s("code",[t._v("event loop")]),t._v("的模型，具体实现留给了浏览器厂商。")])]),t._v(" "),s("h2",{attrs:{id:"nodejs中的event-loop"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nodejs中的event-loop"}},[t._v("#")]),t._v(" "),s("code",[t._v("NodeJS")]),t._v("中的"),s("code",[t._v("event loop")])]),t._v(" "),s("p",[t._v("关于"),s("code",[t._v("nodejs")]),t._v("中的"),s("code",[t._v("event loop")]),t._v("有两个地方可以参考，一个是"),s("code",[t._v("nodejs")]),s("a",{attrs:{href:"https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方的文档"),s("OutboundLink")],1),t._v("；另一个是"),s("code",[t._v("libuv")]),t._v("的"),s("a",{attrs:{href:"http://docs.libuv.org/en/v1.x/design.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方的文档"),s("OutboundLink")],1),t._v("，前者已经对"),s("code",[t._v("nodejs")]),t._v("有一个比较完整的描述，而后者则有更多细节的描述。")]),t._v(" "),s("p",[t._v("看图：")]),t._v(" "),s("p",[s("img",{attrs:{src:n(433),alt:"image from dependency"}})]),t._v(" "),s("ul",[s("li",[t._v("首先我们能看到我们的"),s("code",[t._v("js")]),t._v("代码（"),s("code",[t._v("APPLICATION")]),t._v("）会先进入"),s("code",[t._v("v8")]),t._v("引擎,"),s("code",[t._v("v8")]),t._v("引擎中主要是一些"),s("code",[t._v("setTimeout")]),t._v("之类的方法。")]),t._v(" "),s("li",[t._v("其次如果我们的代码中执行了"),s("code",[t._v("nodeApi")]),t._v("，比如"),s("code",[t._v("require('fs').read()")]),t._v("，"),s("code",[t._v("node")]),t._v("就会交给"),s("code",[t._v("libuv")]),t._v("库处理，这个"),s("code",[t._v("libuv")]),t._v("库是别人写的，他就是"),s("code",[t._v("node")]),t._v("的事件环。")]),t._v(" "),s("li",[s("code",[t._v("libuv")]),t._v("库是通过单线程异步的方式来处理事件，我们可以看到"),s("code",[t._v("work threads")]),t._v("是个多线程的队列，通过外面"),s("code",[t._v("event loop")]),t._v("阻塞的方式来进行异步调用。")]),t._v(" "),s("li",[t._v("等到"),s("code",[t._v("work threads")]),t._v("队列中有执行完成的事件，就会通过"),s("code",[t._v("EXECUTE CALLBACK")]),t._v("回调给"),s("code",[t._v("EVENT QUEUE")]),t._v("队列，把它放入队列中。")]),t._v(" "),s("li",[t._v("最后通过事件驱动的方式，取出"),s("code",[t._v("EVENT QUEUE")]),t._v("队列的事件，交给我们的应用")])]),t._v(" "),s("h2",{attrs:{id:"一、nodejs的event-loop阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、nodejs的event-loop阶段"}},[t._v("#")]),t._v(" 一、"),s("code",[t._v("nodeJS")]),t._v("的"),s("code",[t._v("Event Loop")]),t._v("阶段")]),t._v(" "),s("p",[t._v("当"),s("code",[t._v("Node.js")]),t._v("启动时，会做这几件事：")]),t._v(" "),s("ol",[s("li",[t._v("初始化"),s("code",[t._v("event loop")])]),t._v(" "),s("li",[t._v("开始执行脚本（或者进入"),s("code",[t._v("REPL")]),t._v("）。这些脚本有可能会调用一些异步"),s("code",[t._v("API")]),t._v("、设定定时器或者调用"),s("code",[t._v("process.nextTick()")])]),t._v(" "),s("li",[t._v("开始处理"),s("code",[t._v("event loop")])])]),t._v(" "),s("p",[t._v("处理"),s("code",[t._v("event loop")]),t._v("的过程如图所示：")]),t._v(" "),s("p",[s("img",{attrs:{src:n(434),alt:"image from dependency"}})]),t._v(" "),s("p",[t._v("图中每个方框都是"),s("code",[t._v("event loop")]),t._v("中的一个阶段。")]),t._v(" "),s("p",[t._v("每个阶段都有一个先入先出队列，这个队列存有要执行的回调函数地址。不过每个阶段都有其特有的使命。一般来说，当"),s("code",[t._v("event loop")]),t._v(" 达到某个阶段时，会在这个阶段进行一些特殊的操作，然后执行这个阶段的队列里的所有回调。 下列两种情况之一会停止止执行这些回调：")]),t._v(" "),s("ul",[s("li",[t._v("队列的操作全被执行完了")]),t._v(" "),s("li",[t._v("执行的回调数目到达指定的最大值 然后，"),s("code",[t._v("event loop")]),t._v(" 进入下一个阶段，然后再下一个阶段")])]),t._v(" "),s("p",[t._v("一方面，上面这些操作都有可能添加计时器；另一方面，操作系统会向"),s("code",[t._v("poll")]),t._v("队列中添加新的事件，当"),s("code",[t._v("poll")]),t._v(" 队列中的事件被处理时可能会有新的"),s("code",[t._v("poll")]),t._v("事件进入"),s("code",[t._v("poll")]),t._v(" 队列。结果，耗时较长的回调函数可以让"),s("code",[t._v("event loop")]),t._v("在"),s("code",[t._v("poll")]),t._v(" 阶段停留很久，久到错过了计时器的触发时机。")]),t._v(" "),s("p",[t._v("注意，"),s("code",[t._v("Windows")]),t._v("的实现和"),s("code",[t._v("Unix/Linux")]),t._v(" 的实现稍有不同，不过对本文内容影响不大。本文囊括了"),s("code",[t._v("event loop")]),t._v("最重要的部分，不同平台可能有七个或八个阶段，但是上面的几个阶段是我们真正关心的阶段，而且是"),s("code",[t._v("Node.js")]),t._v(" 真正用到的阶段。")]),t._v(" "),s("h2",{attrs:{id:"二、各阶段概览"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、各阶段概览"}},[t._v("#")]),t._v(" 二、各阶段概览")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("timers")]),t._v("阶段：这个阶段执行"),s("code",[t._v("setTimeout")]),t._v("和 "),s("code",[t._v("setInterval")]),t._v("的回调函数。")]),t._v(" "),s("li",[s("code",[t._v("I/O callbacks")]),t._v("阶段：不在"),s("code",[t._v("timers")]),t._v("阶段、"),s("code",[t._v("close callbacks")]),t._v("阶段和"),s("code",[t._v("check")]),t._v(" 阶段这三个阶段执行的回调，都由此阶段负责，这几乎包含了所有回调函数。")]),t._v(" "),s("li",[s("code",[t._v("idle")]),t._v(", "),s("code",[t._v("prepare")]),t._v("阶段："),s("code",[t._v("event loop")]),t._v("内部使用的阶段。")]),t._v(" "),s("li",[s("code",[t._v("poll")]),t._v("阶段：获取新的"),s("code",[t._v("I/O")]),t._v("事件。在某些场景下"),s("code",[t._v("Node.js")]),t._v(" 会阻塞在这个阶段。")]),t._v(" "),s("li",[s("code",[t._v("check")]),t._v("阶段：执行"),s("code",[t._v("setImmediate()")]),t._v("的回调函数。")]),t._v(" "),s("li",[s("code",[t._v("close callbacks")]),t._v("阶段：执行关闭事件的回调函数，如"),s("code",[t._v("socket.on('close', fn)")]),t._v("里的"),s("code",[t._v("fn")]),t._v("。")])]),t._v(" "),s("p",[t._v("一个"),s("code",[t._v("Node.js")]),t._v("程序结束时，"),s("code",[t._v("Node.js")]),t._v("会检查"),s("code",[t._v("event loop")]),t._v(" 是否在等待异步"),s("code",[t._v("I/O")]),t._v(" 操作结束，是否在等待计时器触发，如果没有，就会关掉"),s("code",[t._v("event loop")]),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"三、各阶段详解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、各阶段详解"}},[t._v("#")]),t._v(" 三、各阶段详解")]),t._v(" "),s("h3",{attrs:{id:"_3-1-timers阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-timers阶段"}},[t._v("#")]),t._v(" 3.1 "),s("code",[t._v("timers")]),t._v("阶段")]),t._v(" "),s("p",[t._v("计时器指定多久以后可以执行某个回调函数。当指定的时间达到后，计时器的回调函数会尽早被执行。如果操作系统很忙，或者"),s("code",[t._v("Node.js")]),t._v("正在执行一个耗时的函数，那么计时器的回调函数就会被推迟执行。")]),t._v(" "),s("p",[t._v("注意，从原理上来说，"),s("code",[t._v("poll")]),t._v(" 阶段能控制计时器的回调函数什么时候被执行。")]),t._v(" "),s("p",[t._v("举例来说，你设置了一个计时器在"),s("code",[t._v("100")]),t._v(" 毫秒后执行，然后你的脚本用了"),s("code",[t._v("95")]),t._v("毫秒来异步读取了一个文件：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fs'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("someAsyncOperation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 假设读取这个文件一共花费 95 毫秒")]),t._v("\n  fs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/path/to/file'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" timeoutScheduled "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" delay "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" timeoutScheduled"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("delay"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("毫秒后执行了 setTimeout 的回调")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 执行一个耗时 95 毫秒的异步操作")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("someAsyncOperation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" startCallback "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 执行一个耗时 10 毫秒的同步操作")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" startCallback "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 什么也不做")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),s("p",[t._v("当"),s("code",[t._v("event loop")]),t._v("进入"),s("code",[t._v("poll")]),t._v("阶段，发现"),s("code",[t._v("poll")]),t._v(" 队列为空（因为文件还没读完），"),s("code",[t._v("event loop")]),t._v(" 检查了一下最近的计时器，大概还有"),s("code",[t._v("100")]),t._v("毫秒时间，于是"),s("code",[t._v("event loop")]),t._v("决定这段时间就停在"),s("code",[t._v("poll")]),t._v("阶段。在"),s("code",[t._v("poll")]),t._v("阶段停了"),s("code",[t._v("95")]),t._v("毫秒之后，"),s("code",[t._v("fs.readFile")]),t._v("操作完成，一个耗时"),s("code",[t._v("10")]),t._v(" 毫秒的回调函数被系统放入"),s("code",[t._v("poll")]),t._v("队列，于是"),s("code",[t._v("event loop")]),t._v(" 执行了这个回调函数。执行完毕后，"),s("code",[t._v("poll")]),t._v("队列为空，于是"),s("code",[t._v("event loop")]),t._v("去看了一眼最近的计时器, "),s("code",[t._v("event loop")]),t._v("发现，已经超时"),s("code",[t._v("95 + 10 - 100 = 5")]),t._v("毫秒了，于是经由"),s("code",[t._v("check")]),t._v("阶段、"),s("code",[t._v("close callbacks")]),t._v("阶段绕回到"),s("code",[t._v("timers")]),t._v("阶段，执行"),s("code",[t._v("timers")]),t._v(" 队列里的那个回调函数。这个例子中，"),s("code",[t._v("100")]),t._v(" 毫秒的计时器实际上是在"),s("code",[t._v("105")]),t._v("毫秒后才执行的。")]),t._v(" "),s("p",[t._v("注意：为了防止"),s("code",[t._v("poll")]),t._v("阶段占用了"),s("code",[t._v("event loop")]),t._v(" 的所有时间，"),s("code",[t._v("libuv")]),t._v("（"),s("code",[t._v("Node.js")]),t._v("用来实现"),s("code",[t._v("event loop")]),t._v("和所有异步行为的"),s("code",[t._v("C")]),t._v("语言写成的库）对"),s("code",[t._v("poll")]),t._v(" 阶段的最长停留时间做出了限制，具体时间因操作系统而异。")]),t._v(" "),s("h3",{attrs:{id:"_3-2-i-o-callbacks阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-i-o-callbacks阶段"}},[t._v("#")]),t._v(" 3.2 "),s("code",[t._v("I/O callbacks")]),t._v("阶段")]),t._v(" "),s("p",[t._v("这个阶段会执行一些系统操作的回调函数，比如"),s("code",[t._v("TCP")]),t._v(" 报错，如果一个"),s("code",[t._v("TCP socket")]),t._v("开始连接时出现了"),s("code",[t._v("ECONNREFUSED")]),t._v(" 错误，一些"),s("code",[t._v("*nix")]),t._v("系统就会（向 "),s("code",[t._v("Node.js")]),t._v("）通知这个错误。这个通知就会被放入"),s("code",[t._v("I/O callbacks")]),t._v("队列。")]),t._v(" "),s("h3",{attrs:{id:"_3-3-poll阶段-轮询阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-poll阶段-轮询阶段"}},[t._v("#")]),t._v(" 3.3 "),s("code",[t._v("poll")]),t._v("阶段（轮询阶段）")]),t._v(" "),s("p",[s("code",[t._v("poll")]),t._v("阶段有两个功能：")]),t._v(" "),s("ol",[s("li",[t._v("如果发现计时器的时间到了，就绕回到"),s("code",[t._v("timers")]),t._v(" 阶段执行计时器的回调。")]),t._v(" "),s("li",[t._v("然后再执行"),s("code",[t._v("poll")]),t._v("队列里的回调。")])]),t._v(" "),s("p",[t._v("当"),s("code",[t._v("event loop")]),t._v("进入"),s("code",[t._v("poll")]),t._v("阶段，如果发现没有计时器，就会：")]),t._v(" "),s("ol",[s("li",[t._v("如果"),s("code",[t._v("poll")]),t._v("队列不是空的，"),s("code",[t._v("event loop")]),t._v(" 就会依次执行队列里的回调函数，直到队列被清空或者到达"),s("code",[t._v("poll")]),t._v(" 阶段的时间上限。")]),t._v(" "),s("li",[t._v("如果"),s("code",[t._v("poll")]),t._v("队列是空的，就会：")])]),t._v(" "),s("ul",[s("li",[t._v("如果有"),s("code",[t._v("setImmediate()")]),t._v("任务，"),s("code",[t._v("event loop")]),t._v("就结束"),s("code",[t._v("poll")]),t._v(" 阶段去往"),s("code",[t._v("check")]),t._v("阶段。")]),t._v(" "),s("li",[t._v("如果没有"),s("code",[t._v("setImmediate()")]),t._v("任务，"),s("code",[t._v("event loop")]),t._v(" 就会等待新的回调函数进入"),s("code",[t._v("poll")]),t._v("队列，并立即执行它。")])]),t._v(" "),s("p",[t._v("一旦"),s("code",[t._v("poll")]),t._v("队列为空，"),s("code",[t._v("event loop")]),t._v(" 就会检查计时器有没有到期，如果有计时器到期了，"),s("code",[t._v("event loop")]),t._v(" 就会回到"),s("code",[t._v("timers")]),t._v("阶段执行计时器的回调。")]),t._v(" "),s("h3",{attrs:{id:"_3-4-check阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-check阶段"}},[t._v("#")]),t._v(" 3.4 "),s("code",[t._v("check")]),t._v("阶段")]),t._v(" "),s("p",[t._v("这个阶段允许开发者在"),s("code",[t._v("poll")]),t._v("阶段结束后立即执行一些函数。如果 "),s("code",[t._v("poll")]),t._v("阶段空闲了，同时存在"),s("code",[t._v("setImmediate()")]),t._v("任务，"),s("code",[t._v("event loop")]),t._v("就会进入"),s("code",[t._v("check")]),t._v("阶段。")]),t._v(" "),s("p",[s("code",[t._v("setImmediate()")]),t._v(" 实际上是一种特殊的计时器，有自己特有的阶段。它是通过"),s("code",[t._v("libuv")]),t._v(" 里一个能将回调安排在"),s("code",[t._v("poll")]),t._v("阶段之后执行的"),s("code",[t._v("API")]),t._v("实现的。")]),t._v(" "),s("p",[t._v("一般来说，当代码执行后，"),s("code",[t._v("event loop")]),t._v("最终会达到"),s("code",[t._v("poll")]),t._v(" 阶段，等待新的连接、新的请求等。但是如果一个回调是由 "),s("code",[t._v("setImmediate()")]),t._v("发出的，同时"),s("code",[t._v("poll")]),t._v("阶段空闲下来了，"),s("code",[t._v("event loop")]),t._v("就会结束"),s("code",[t._v("poll")]),t._v("阶段进入"),s("code",[t._v("check")]),t._v("阶段，不再等待新的"),s("code",[t._v("poll")]),t._v("事件。")]),t._v(" "),s("h3",{attrs:{id:"_3-5-close-callbacks阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-close-callbacks阶段"}},[t._v("#")]),t._v(" 3.5 "),s("code",[t._v("close callbacks")]),t._v("阶段")]),t._v(" "),s("p",[t._v("如果一个"),s("code",[t._v("socket")]),t._v("或者"),s("code",[t._v("handle")]),t._v("被突然关闭（比如 "),s("code",[t._v("socket.destroy()")]),t._v("），那么就会有一个"),s("code",[t._v("close")]),t._v(" 事件进入这个阶段。否则，这个"),s("code",[t._v("close")]),t._v("事件就会经过 "),s("code",[t._v("process.nextTick()")]),t._v("触发。")]),t._v(" "),s("h2",{attrs:{id:"微任务和宏任务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#微任务和宏任务"}},[t._v("#")]),t._v(" 微任务和宏任务")]),t._v(" "),s("p",[t._v("每次执行栈的同步任务执行完毕，就会去任务队列中取出完成的异步任务，队列中又分为"),s("code",[t._v("microtasks queues")]),t._v("和宏任务队。等到把"),s("code",[t._v("microtasks queues")]),t._v("所有的"),s("code",[t._v("microtasks")]),t._v("都执行完毕,注意是所有的,他才会从宏任务队列中取事件。等到把队列中的事件取出一个，放入执行栈执行完成，就算一次循环结束，之后"),s("code",[t._v("event loop")]),t._v("继续循环，他会再去"),s("code",[t._v("microtasks queues")]),t._v("执行所有的任务，然后再从宏任务队列里面取一个，如此反复循环。")]),t._v(" "),s("ul",[s("li",[t._v("同步任务执行完")]),t._v(" "),s("li",[t._v("去执行"),s("code",[t._v("microtasks")]),t._v("，把所有"),s("code",[t._v("microtasks queues")]),t._v("清空")]),t._v(" "),s("li",[t._v("取出一个"),s("code",[t._v("macrotasks queues")]),t._v("的完成事件，在执行栈执行")]),t._v(" "),s("li",[t._v("再去执行"),s("code",[t._v("microtasks")])]),t._v(" "),s("li",[s("code",[t._v("...")])]),t._v(" "),s("li",[s("code",[t._v("...")])]),t._v(" "),s("li",[s("code",[t._v("...")])])]),t._v(" "),s("h3",{attrs:{id:"macrotasks与microtasks的区别"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#macrotasks与microtasks的区别"}},[t._v("#")]),t._v(" "),s("code",[t._v("macrotasks")]),t._v("与"),s("code",[t._v("microtasks")]),t._v("的区别")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("macrotasks")]),t._v(": "),s("code",[t._v("setTimeout")]),t._v("、"),s("code",[t._v("setInterval")]),t._v(" 、"),s("code",[t._v("setImmediate")]),t._v("、 "),s("code",[t._v("I/O")]),t._v("、"),s("code",[t._v("UI")]),t._v("渲染")]),t._v(" "),s("li",[s("code",[t._v("microtasks")]),t._v(": "),s("code",[t._v("Promise")]),t._v("、 "),s("code",[t._v("process.nextTick")]),t._v("、"),s("code",[t._v("Object.observe")]),t._v("、 "),s("code",[t._v("MutationObserver")]),t._v("。")])]),t._v(" "),s("p",[t._v("在"),s("a",{attrs:{href:"https://promisesaplus.com/#notes",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Promise/A+")]),t._v("的规范"),s("OutboundLink")],1),t._v("中，"),s("code",[t._v("Promise")]),t._v("的实现可以是微任务，也可以是宏任务，但是普遍的共识表示(至少"),s("code",[t._v("Chrome")]),t._v("是这么做的)，"),s("code",[t._v("Promise")]),t._v(" 应该是属于微任务阵营的")]),t._v(" "),s("p",[t._v("看图：")]),t._v(" "),s("p",[s("img",{attrs:{src:n(435),alt:"image from dependency"}})]),t._v(" "),s("p",[t._v("绿色小块是"),s("code",[t._v("macrotask")]),t._v("（宏任务），"),s("code",[t._v("macrotask")]),t._v(" 中间的粉红箭头是"),s("code",[t._v("microtask")]),t._v("（微任务）。")]),t._v(" "),s("p",[t._v("举个例子：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'A'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" obj"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("func")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'B'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'C'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("func")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'D'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'E'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("ol",[s("li",[t._v("首先"),s("code",[t._v("setTimeout A")]),t._v("被加入到事件队列中"),s("code",[t._v("==>")]),t._v(" 此时"),s("code",[t._v("macrotasks")]),t._v("中有"),s("code",[t._v("[‘A’]")]),t._v("；")]),t._v(" "),s("li",[s("code",[t._v("obj.func()")]),t._v("执行时，"),s("code",[t._v("setTimeout B")]),t._v(" 被加入到事件队列中"),s("code",[t._v("==>")]),t._v(" 此时"),s("code",[t._v("macrotasks")]),t._v("中有"),s("code",[t._v("[‘A’，‘B’]")]),t._v("；")]),t._v(" "),s("li",[t._v("接着"),s("code",[t._v("return")]),t._v("一个"),s("code",[t._v("Promise")]),t._v("对象，"),s("code",[t._v("Promise")]),t._v(" 新建后立即执行 执行"),s("code",[t._v("console.log('C')")]),t._v("; 控制台首次打印"),s("code",[t._v("‘C’")]),t._v(";")]),t._v(" "),s("li",[t._v("然后，"),s("code",[t._v("then")]),t._v("方法指定的回调函数，被加入到"),s("code",[t._v("microtasks")]),t._v("当前脚本所有同步任务执行完才会执行。 "),s("code",[t._v("==>")]),t._v(" 此时"),s("code",[t._v("microtasks")]),t._v("中有"),s("code",[t._v("[‘D’]")]),t._v("；")]),t._v(" "),s("li",[t._v("然后继续执行当前脚本的同步任务，故控制台第二次输出"),s("code",[t._v("‘E’")]),t._v("；")]),t._v(" "),s("li",[t._v("此时所有同步任务执行完毕，如上所述先检查"),s("code",[t._v("microtasks")]),t._v("其中所有任务，故控制台第三次输出"),s("code",[t._v("‘D’")]),t._v("；")]),t._v(" "),s("li",[t._v("最后再执行"),s("code",[t._v("macrotask")]),t._v("的任务，并且按照入队列的时间顺序，控制台第四次输出"),s("code",[t._v("‘A’")]),t._v("，控制台第五次输出"),s("code",[t._v("‘B’")]),t._v("。")])]),t._v(" "),s("h2",{attrs:{id:"四、setimmediate-vs-settimeout"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#四、setimmediate-vs-settimeout"}},[t._v("#")]),t._v(" 四、"),s("code",[t._v("setImmediate() vs setTimeout()")])]),t._v(" "),s("p",[s("code",[t._v("setImmediate")]),t._v("和"),s("code",[t._v("setTimeout")]),t._v(" 很相似，但是其回调函数的调用时机却不一样。")]),t._v(" "),s("p",[s("code",[t._v("setImmediate()")]),t._v("的作用是在当前"),s("code",[t._v("poll")]),t._v(" 阶段结束后调用一个函数。 "),s("code",[t._v("setTimeout()")]),t._v(" 的作用是在一段时间后调用一个函数。 这两者的回调的执行顺序取决于"),s("code",[t._v("setTimeout")]),t._v("和"),s("code",[t._v("setImmediate")]),t._v(" 被调用时的环境。")]),t._v(" "),s("p",[t._v("举例来说，如果在主模块中运行下面的脚本，那么两个回调的执行顺序是无法判断的：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'timeout'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setImmediate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'immediate'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("运行结果如下：")]),t._v(" "),s("div",{staticClass:"language-script extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ node timeout_vs_immediate.js\ntimeout\nimmediate\n\n$ node timeout_vs_immediate.js\nimmediate\ntimeout\n")])])]),s("p",[s("code",[t._v("setTimeout/setInterval")]),t._v("的第二个参数取值范围是："),s("code",[t._v("[1, 2^31 - 1]")]),t._v("，如果超过这个范围则会初始化为"),s("code",[t._v("1")]),t._v("，即"),s("code",[t._v("setTimeout(fn, 0) === setTimeout(fn, 1)")]),t._v("。我们知道"),s("code",[t._v("setTimeout")]),t._v("的回调函数在"),s("code",[t._v("timer")]),t._v("阶段执行，"),s("code",[t._v("setImmediate")]),t._v("的回调函数在 "),s("code",[t._v("check")]),t._v("阶段执行，"),s("code",[t._v("event loop")]),t._v("的开始会先检查"),s("code",[t._v("timer")]),t._v(" 阶段，但是在开始之前到"),s("code",[t._v("timer")]),t._v(" 阶段会消耗一定时间，所以就会出现两种情况：")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("timer")]),t._v("前的准备时间超过"),s("code",[t._v("1ms")]),t._v("，满足"),s("code",[t._v("loop->time >= 1")]),t._v("，则执行"),s("code",[t._v("timer")]),t._v("阶段（"),s("code",[t._v("setTimeout")]),t._v("）的回调函数")]),t._v(" "),s("li",[s("code",[t._v("timer")]),t._v("前的准备时间小于"),s("code",[t._v("1ms")]),t._v("，则先执行"),s("code",[t._v("check")]),t._v(" 阶段（"),s("code",[t._v("setImmediate")]),t._v("）的回调函数，下一次"),s("code",[t._v("event loop")]),t._v("执行 "),s("code",[t._v("timer")]),t._v("阶段（"),s("code",[t._v("setTimeout")]),t._v("）的回调函数")])]),t._v(" "),s("p",[t._v("但是，如果把上面代码放到"),s("code",[t._v("I/O")]),t._v("操作的回调里，"),s("code",[t._v("setImmediate")]),t._v("的回调就总是优先于"),s("code",[t._v("setTimeout")]),t._v("的回调：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// timeout_vs_immediate.js")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fs'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nfs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__filename"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'timeout'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setImmediate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'immediate'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),s("p",[t._v("运行结果如下：")]),t._v(" "),s("div",{staticClass:"language-script extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ node timeout_vs_immediate.js\nimmediate\ntimeout\n")])])]),s("p",[s("code",[t._v("fs.readFile")]),t._v("的回调函数执行完后：")]),t._v(" "),s("ol",[s("li",[t._v("注册"),s("code",[t._v("setTimeout")]),t._v("的回调函数到"),s("code",[t._v("timer")]),t._v("阶段")]),t._v(" "),s("li",[t._v("注册"),s("code",[t._v("setImmediate")]),t._v("的回调函数到"),s("code",[t._v("check")])]),t._v(" "),s("li",[s("code",[t._v("event loop")]),t._v("从"),s("code",[t._v("pool")]),t._v("阶段出来继续往下一个阶段执行，恰好是"),s("code",[t._v("check")]),t._v("阶段，所以"),s("code",[t._v("setImmediate")]),t._v("的回调函数先执行")]),t._v(" "),s("li",[t._v("本次"),s("code",[t._v("event loop")]),t._v("结束后，进入下一次"),s("code",[t._v("event loop")]),t._v("，执行 "),s("code",[t._v("setTimeout")]),t._v("的回调函数")])]),t._v(" "),s("p",[t._v("所以，在"),s("code",[t._v("I/O Callbacks")]),t._v("中注册的"),s("code",[t._v("setTimeout")]),t._v("和"),s("code",[t._v("setImmediate")]),t._v("，永远都是"),s("code",[t._v("setImmediate")]),t._v("先执行。")]),t._v(" "),s("h2",{attrs:{id:"五、process-nexttick"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#五、process-nexttick"}},[t._v("#")]),t._v(" 五、"),s("code",[t._v("process.nextTick()")])]),t._v(" "),s("p",[t._v("在任何一个阶段调用"),s("code",[t._v("process.nextTick")]),t._v("(回调)，回调都会在当前阶段继续运行前被调用。这种行为有的时候会造成不好的结果，因为可以递归地调用"),s("code",[t._v("process.nextTick()")]),t._v("，这样"),s("code",[t._v("event loop")]),t._v(" 就会一直停在当前阶段不走,无法进入"),s("code",[t._v("poll")]),t._v("阶段。")]),t._v(" "),s("p",[t._v("比如如下代码：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setInterval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'setInterval'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nprocess"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tick")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tick"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("运行结果："),s("code",[t._v("setInterval")]),t._v("永远不会打印出来。")]),t._v(" "),s("p",[s("code",[t._v("process.nextTick")]),t._v("会无限循环,使"),s("code",[t._v("event loop")]),t._v("停留在当前阶段，无法进入"),s("code",[t._v("timers")]),t._v("阶段。")]),t._v(" "),s("p",[t._v("解决方法通常是用"),s("code",[t._v("setImmediate")]),t._v("替代"),s("code",[t._v("process.nextTick")]),t._v("，如下：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setInterval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'setInterval'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setImmediate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("immediate")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setImmediate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("immediate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[s("code",[t._v("setImmediate")]),t._v("内执行"),s("code",[t._v("setImmediate")]),t._v("会将"),s("code",[t._v("immediate")]),t._v("函数注册到下一次"),s("code",[t._v("event loop")]),t._v("的"),s("code",[t._v("check")]),t._v("阶段，而不是当前正在执行的"),s("code",[t._v("check")]),t._v("阶段，所以给了"),s("code",[t._v("event loop")]),t._v("上其他阶段执行的机会。")]),t._v(" "),s("h2",{attrs:{id:"六、process-nexttick-vs-setimmediate"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#六、process-nexttick-vs-setimmediate"}},[t._v("#")]),t._v(" 六、"),s("code",[t._v("process.nextTick() vs setImmediate()")])]),t._v(" "),s("p",[s("code",[t._v("process.nextTick()")]),t._v("的回调会在当前"),s("code",[t._v("event loop")]),t._v("阶段「立即」执行。 "),s("code",[t._v("setImmediate()")]),t._v("的回调会在后续的"),s("code",[t._v("event loop")]),t._v(" 周期（"),s("code",[t._v("tick")]),t._v("）执行。")]),t._v(" "),s("p",[t._v("推荐开发者在任何情况下都使用"),s("code",[t._v("setImmediate()")]),t._v("，因为它的兼容性更好，而且它更容易理解。")]),t._v(" "),s("h2",{attrs:{id:"七、什么时候用process-nexttick"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#七、什么时候用process-nexttick"}},[t._v("#")]),t._v(" 七、什么时候用"),s("code",[t._v("process.nextTick()")])]),t._v(" "),s("p",[t._v("使用的理由有两个：")]),t._v(" "),s("ol",[s("li",[t._v("让开发者处理错误、清除无用的资源，或者在"),s("code",[t._v("event loop")]),t._v("当前阶段结束前尝试重新请求资源")]),t._v(" "),s("li",[t._v("有时候有必要让一个回调在调用栈"),s("code",[t._v("unwind")]),t._v("之后，"),s("code",[t._v("event loop")]),t._v("进入下阶段之前执行")])]),t._v(" "),s("p",[t._v("为了让代码更合理，我们可能会写这样的代码：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" server "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" net"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createServer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nserver"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'connection'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("conn")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nserver"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nserver"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'listening'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("假设"),s("code",[t._v("listen()")]),t._v("在"),s("code",[t._v("event loop")]),t._v("一启动的时候就执行了，而"),s("code",[t._v("listening")]),t._v("事件的回调被放在了"),s("code",[t._v("setImmediate()")]),t._v("里，"),s("code",[t._v("listen")]),t._v(" 动作是立即发生的，如果想要"),s("code",[t._v("event loop")]),t._v("执行"),s("code",[t._v("listening")]),t._v("回调，就必须先经过"),s("code",[t._v("poll")]),t._v("阶段，当时"),s("code",[t._v("poll")]),t._v(" 阶段有可能会停留，以等待连接，这样一来就有可能出现"),s("code",[t._v("connect")]),t._v("事件的回调比"),s("code",[t._v("listening")]),t._v("事件的回调先执行。这显然不合理，所以我们需要用 "),s("code",[t._v("process.nextTick")])]),t._v(" "),s("p",[t._v("再举一个例子，一个类继承了"),s("code",[t._v("EventEmitter")]),t._v("，而且想在实例化的时候触发一个事件：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" EventEmitter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'events'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" util "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'util'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("MyEmitter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("EventEmitter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("emit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'event'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nutil"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("inherits")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("MyEmitter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" EventEmitter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" myEmitter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyEmitter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nmyEmitter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'event'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'an event occurred!'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),s("p",[t._v("不能直接在构造函数里执行"),s("code",[t._v("this.emit('event')")]),t._v("，因为这样的话后面的回调就永远无法执行。把"),s("code",[t._v("this.emit('event')")]),t._v("放在"),s("code",[t._v("process.nextTick()")]),t._v("里，后面的回调就可以执行，这才是我们预期的行为：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" EventEmitter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'events'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" util "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'util'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("MyEmitter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("EventEmitter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// use nextTick to emit the event once a handler is assigned")]),t._v("\n  process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("emit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'event'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nutil"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("inherits")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("MyEmitter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" EventEmitter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" myEmitter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyEmitter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nmyEmitter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'event'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'an event occurred!'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h2",{attrs:{id:"参考文献"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[t._v("#")]),t._v(" 参考文献：")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://juejin.im/post/5ab7677f6fb9a028d56711d0",target:"_blank",rel:"noopener noreferrer"}},[t._v("Event Loop、计时器、nextTick"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("原文： "),s("a",{attrs:{href:"https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/34182184",target:"_blank",rel:"noopener noreferrer"}},[t._v("Event Loop 必知必会（六道题）"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("a",{attrs:{href:"https://juejin.im/post/5b35cdfa51882574c020d685",target:"_blank",rel:"noopener noreferrer"}},[t._v("node基础面试事件环？微任务、宏任务？一篇带你飞"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("a",{attrs:{href:"https://juejin.im/post/5b73d7a6518825610072b42b",target:"_blank",rel:"noopener noreferrer"}},[t._v("微任务、宏任务与Event-Loop"),s("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=e.exports}}]);