(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{536:function(e,o,t){"use strict";t.r(o);var v=t(5),_=Object(v.a)({},(function(){var e=this,o=e._self._c;return o("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[o("h2",{attrs:{id:"event-loop"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#event-loop"}},[e._v("#")]),e._v(" "),o("code",[e._v("event loop")])]),e._v(" "),o("p",[e._v("通过"),o("a",{attrs:{href:"https://www.w3.org/TR/html5/webappapis.html#event-loops-definitions",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("HTML5")]),e._v("规范"),o("OutboundLink")],1),e._v("的定义来看"),o("code",[e._v("event loop")]),e._v("的定义")]),e._v(" "),o("blockquote",[o("p",[e._v("为了协调时间，用户交互，脚本，界面渲染，网络等等，用户代理必须使用下一节描述的 event loops。event loops 分为两种：浏览器环境及为 Web Worker 服务的。")])]),e._v(" "),o("p",[e._v("在这里只关注浏览器部分，"),o("code",[e._v("JavaScript")]),e._v(" 引擎并不是独立运行的，它需要运行在宿主环境中， 所以其实用户代理（"),o("code",[e._v("user agent")]),e._v("）或者称为运行环境或者宿主环境，也就是浏览器。")]),e._v(" "),o("blockquote",[o("p",[e._v("每个用户代理必须至少有一个"),o("a",{attrs:{href:"https://www.w3.org/TR/html5/browsers.html#browsing-context",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("browsing context event loop")]),o("OutboundLink")],1),e._v("，但每个"),o("a",{attrs:{href:"https://www.w3.org/TR/html5/browsers.html#units-of-related-similar-origin-browsing-contexts",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("unit of related similar-origin browsing contexts")]),o("OutboundLink")],1),e._v(" 最多只能有一个。")])]),e._v(" "),o("p",[e._v("关于"),o("a",{attrs:{href:"https://www.w3.org/TR/html5/browsers.html#units-of-related-similar-origin-browsing-contexts",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("unit of related similar-origin browsing contexts")]),o("OutboundLink")],1),e._v("，节选一部分规范的介绍：")]),e._v(" "),o("blockquote",[o("p",[e._v("Each "),o("a",{attrs:{href:"https://www.w3.org/TR/html5/browsers.html#unit-of-related-browsing-contexts",target:"_blank",rel:"noopener noreferrer"}},[e._v(" unit of related browsing contexts "),o("OutboundLink")],1),e._v(" is then further divided into the smallest number of groups such that every member of each group has an "),o("a",{attrs:{href:"https://www.w3.org/TR/html5/browsers.html#active-document",target:"_blank",rel:"noopener noreferrer"}},[e._v("active document"),o("OutboundLink")],1),e._v(" with an "),o("a",{attrs:{href:"https://www.w3.org/TR/html5/browsers.html#concept-origin",target:"_blank",rel:"noopener noreferrer"}},[e._v("origin"),o("OutboundLink")],1),e._v(" that, through appropriate manipulation of the document.domain attribute, could be made to be "),o("a",{attrs:{href:"https://www.w3.org/TR/html5/browsers.html#same-origin-domain",target:"_blank",rel:"noopener noreferrer"}},[e._v("same origin-domain"),o("OutboundLink")],1),e._v(" with other members of the group, but could not be made the same as members of any other group. Each such group is a unit of related similar-origin browsing contexts.")])]),e._v(" "),o("p",[e._v("简而言之就是一个浏览器环境（"),o("code",[e._v("unit of related similar-origin browsing contexts.")]),e._v("），只能有一个事件循环（"),o("code",[e._v("event loop")]),e._v("）。")]),e._v(" "),o("h3",{attrs:{id:"event-loop做了什么"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#event-loop做了什么"}},[e._v("#")]),e._v(" "),o("code",[e._v("event loop")]),e._v("做了什么？")]),e._v(" "),o("blockquote",[o("p",[e._v("每个"),o("code",[e._v("event loop")]),e._v("都有一个或多个 task queues. 一个"),o("a",{attrs:{href:"https://www.w3.org/TR/html5/webappapis.html#task-queues",target:"_blank",rel:"noopener noreferrer"}},[e._v(" task queue "),o("OutboundLink")],1),e._v("是"),o("code",[e._v("tasks")]),e._v("的有序的列表, 是用来响应如下工作的算法:")]),e._v(" "),o("ul",[o("li",[o("p",[e._v("事件")]),e._v(" "),o("p",[e._v("在"),o("code",[e._v("EventTarget")]),e._v("触发的时候发布一个事件"),o("code",[e._v("Event")]),e._v(" 对象，这通常由一个专属的 task 完成。")]),e._v(" "),o("p",[e._v("注意：并不是所有的事件都从是"),o("a",{attrs:{href:"https://www.w3.org/TR/html5/webappapis.html#task-queues",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("task queue")]),o("OutboundLink")],1),e._v("中发布，也有很多是来自其他的 tasks。")])]),e._v(" "),o("li",[o("p",[e._v("解析")]),e._v(" "),o("p",[o("a",{attrs:{href:"https://www.w3.org/TR/html5/syntax.html#html-parser",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("HTML")]),e._v("解析器 "),o("OutboundLink")],1),e._v("令牌化然后产生"),o("code",[e._v("token")]),e._v("的过程，是一个典型的"),o("code",[e._v("task")]),e._v("。")])]),e._v(" "),o("li",[o("p",[e._v("回调函数")])])]),e._v(" "),o("p",[e._v("一般使用一个特定的"),o("code",[e._v("task")]),e._v("来调用一个回调函数。")]),e._v(" "),o("ul",[o("li",[o("p",[e._v("使用资源（其实就是网络）")]),e._v(" "),o("p",[e._v("当算法"),o("a",{attrs:{href:"https://fetch.spec.whatwg.org/#concept-fetch",target:"_blank",rel:"noopener noreferrer"}},[e._v(" 获取"),o("OutboundLink")],1),e._v(" 到了资源，如果获取资源的过程是非阻塞的，那么一旦获取了部分或者全部的内容将由"),o("code",[e._v("task")]),e._v("来执行这个过程。")])]),e._v(" "),o("li",[o("p",[e._v("响应"),o("code",[e._v("DOM")]),e._v("的操作")]),e._v(" "),o("p",[e._v("有一些元素会对"),o("code",[e._v("DOM")]),e._v("的操作产生"),o("code",[e._v("task")]),e._v("，比如当元素被"),o("a",{attrs:{href:"https://www.w3.org/TR/html5/infrastructure.html#document-inserted-into",target:"_blank",rel:"noopener noreferrer"}},[e._v(" 插入到 "),o("code",[e._v("document")]),e._v(" 时"),o("OutboundLink")],1),e._v("。")])])])]),e._v(" "),o("p",[e._v("可以看到，一个页面只有一个"),o("code",[e._v("event loop")]),e._v("，但是一个 "),o("code",[e._v("event loop")]),e._v("可以有多个"),o("code",[e._v("task queues")])]),e._v(" "),o("blockquote",[o("p",[e._v("每个来自相同"),o("code",[e._v("task source")]),e._v("并由相同"),o("code",[e._v("event loop")]),e._v("（比如，"),o("code",[e._v("Document")]),e._v("的计时器产生的回调函数，"),o("code",[e._v("Document")]),e._v("的鼠标移动产生的事件，"),o("code",[e._v("Document")]),e._v("的解析器产生的 "),o("code",[e._v("tasks")]),e._v("） 管理的"),o("code",[e._v("task")]),e._v("都必须加入到同一个"),o("code",[e._v("task queue")]),e._v("中，可是来自不同  "),o("a",{attrs:{href:"https://www.w3.org/TR/html5/webappapis.html#task-source",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("task sources")]),o("OutboundLink")],1),e._v(" 的"),o("code",[e._v("tasks")]),e._v("可能会被排入到不同的"),o("code",[e._v("task queues")]),e._v("中。")])]),e._v(" "),o("p",[e._v("规范对"),o("code",[e._v("task source")]),e._v("进行了分类：")]),e._v(" "),o("blockquote",[o("p",[e._v("如下"),o("code",[e._v("task sources")]),e._v(" 被大量应用于本规范或其他规范无关的特性中：")]),e._v(" "),o("ul",[o("li",[o("p",[o("code",[e._v("DOM")]),e._v("操作的"),o("code",[e._v("task source")])]),e._v(" "),o("p",[e._v("这种"),o("code",[e._v("task source")]),e._v("用来对"),o("code",[e._v("DOM")]),e._v(" 的操作进行反应，比如像"),o("code",[e._v("inserted into the document")]),e._v("的非阻塞的行为。")])]),e._v(" "),o("li",[o("p",[e._v("用户操作的"),o("code",[e._v("task source")])]),e._v(" "),o("p",[e._v("这种"),o("code",[e._v("task source")]),e._v(" 用来响应用户的反应，比如鼠标和键盘的事件。这些用来反应用户输入的事件必须由"),o("a",{attrs:{href:"https://www.w3.org/TR/html5/webappapis.html#user-interaction-task-source",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("user interaction task source")]),e._v(" "),o("OutboundLink")],1),e._v("来触发并排入"),o("code",[e._v("tasks queued")]),e._v("。")])]),e._v(" "),o("li",[o("p",[e._v("网络"),o("code",[e._v("task source")])]),e._v(" "),o("p",[e._v("这种"),o("code",[e._v("task source")]),e._v("用来反应网络活动的响应。")])]),e._v(" "),o("li",[o("p",[e._v("时间旅行"),o("code",[e._v("task source")])]),e._v(" "),o("p",[e._v("这种"),o("code",[e._v("task source")]),e._v("用来将"),o("code",[e._v("history.back()")]),e._v("等"),o("code",[e._v("API")]),e._v("排入"),o("code",[e._v("task queue")]),e._v("。")])])])]),e._v(" "),o("p",[e._v("规范中明确表示了是有多个"),o("code",[e._v("task queues")]),e._v("，并举例说明了这样设计的意义：")]),e._v(" "),o("blockquote",[o("p",[e._v("举例来说，一个用户代理可以有一个处理键盘鼠标事件的 "),o("code",[e._v("task queue")]),e._v("（来自"),o("code",[e._v("user interaction task source")]),e._v(")，还有一个"),o("code",[e._v("task queue")]),e._v(" 来处理所有其他的。用户代理可以以"),o("code",[e._v("75%")]),e._v(" 的几率先处理鼠标和键盘的事件，这样既不会彻底不执行其他 "),o("code",[e._v("task queues")]),e._v("的前提下保证用户界面的响应， 而且不会让来自同一个"),o("code",[e._v("task source")]),e._v("的事件顺序错乱。")])]),e._v(" "),o("p",[e._v("接着：")]),e._v(" "),o("blockquote",[o("p",[e._v("当用户代理将要排入任务时，必须将任务排入相关的"),o("code",[e._v("event loop")]),e._v("的"),o("code",[e._v("task queues")]),e._v("。")])]),e._v(" "),o("p",[e._v("这句话很关键，是用户代理（宿主环境/运行环境/浏览器）来控制任务的调度，这里就引出了下面的"),o("code",[e._v("Web APIs")]),e._v("。")]),e._v(" "),o("p",[e._v("接下来我么来看看"),o("code",[e._v("event loop")]),e._v("是如何执行"),o("code",[e._v("task")]),e._v("的。")]),e._v(" "),o("h3",{attrs:{id:"处理模型"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#处理模型"}},[e._v("#")]),e._v(" 处理模型")]),e._v(" "),o("p",[o("code",[e._v("event loop")]),e._v("会在整个页面存在时不停的将"),o("code",[e._v("task queues")]),e._v(" 中的函数拿出来执行，具体的规则如下：")]),e._v(" "),o("p",[e._v("一个"),o("code",[e._v("event loop")]),e._v("在它存在的必须不断的重复一下的步骤：")]),e._v(" "),o("ol",[o("li",[e._v("从"),o("code",[e._v("task queues")]),e._v("中取出"),o("code",[e._v("event loop")]),e._v("的最先添加的 "),o("code",[e._v("task")]),e._v("，如果没有可以选择的"),o("code",[e._v("task")]),e._v("，那么跳到第 "),o("code",[e._v("Microtasks")]),e._v("步。")]),e._v(" "),o("li",[e._v("设定"),o("code",[e._v("event loop")]),e._v("当前执行的"),o("code",[e._v("task")]),e._v("为上一步中选择的 "),o("code",[e._v("task")]),e._v("。\n执行：执行选中的"),o("code",[e._v("task")]),e._v("。")]),e._v(" "),o("li",[e._v("执行：执行选中的"),o("code",[e._v("task")]),e._v("。")]),e._v(" "),o("li",[e._v("将"),o("code",[e._v("event loop")]),e._v("的当前执行"),o("code",[e._v("task")]),e._v("设为"),o("code",[e._v("null")]),e._v("。")]),e._v(" "),o("li",[e._v("从"),o("code",[e._v("task queue")]),e._v("中将刚刚执行的"),o("code",[e._v("task")]),e._v("移除。")]),e._v(" "),o("li",[o("code",[e._v("Microtasks")]),e._v("： "),o("a",{attrs:{href:"https://www.w3.org/TR/html5/webappapis.html#performs-a-microtask-checkpoint",target:"_blank",rel:"noopener noreferrer"}},[e._v("执行"),o("code",[e._v("microtask")]),e._v(" 检查点的任务"),o("OutboundLink")],1),e._v("。")]),e._v(" "),o("li",[e._v("更新渲染，如果是浏览器环境中的"),o("code",[e._v("event loop")]),e._v("（相对来说就是"),o("code",[e._v("Worker")]),e._v("中的"),o("code",[e._v("event loop")]),e._v("）那么执行以下步骤：")]),e._v(" "),o("li",[e._v("如果是"),o("code",[e._v("Worker")]),e._v("环境中的"),o("code",[e._v("event loop")]),e._v("（例如，在"),o("a",{attrs:{href:"https://www.w3.org/TR/workers/#workerglobalscope",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("WorkerGlobalScope")]),o("OutboundLink")],1),e._v("中运行），可是在"),o("code",[e._v("event loop")]),e._v("的"),o("code",[e._v("task queues")]),e._v("中没有 "),o("code",[e._v("tasks")]),e._v("并且  "),o("a",{attrs:{href:"https://www.w3.org/TR/workers/#workerglobalscope",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("WorkerGlobalScope")]),e._v(" "),o("OutboundLink")],1),e._v("对象为关闭的标志，那么销毁"),o("code",[e._v("event loop")]),e._v("，终止这些步骤的执行，恢复到"),o("a",{attrs:{href:"https://www.w3.org/TR/workers/#run-a-worker",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("run a worker")]),e._v(" "),o("OutboundLink")],1),e._v("的步骤。")]),e._v(" "),o("li",[e._v("回到第"),o("code",[e._v("1")]),e._v("步。")])]),e._v(" "),o("h3",{attrs:{id:"microtask"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#microtask"}},[e._v("#")]),e._v(" "),o("code",[e._v("microtask")])]),e._v(" "),o("p",[e._v("规范引出了"),o("code",[e._v("microtask")]),e._v("，")]),e._v(" "),o("blockquote",[o("p",[e._v("每个"),o("code",[e._v("event loop")]),e._v("都有一个"),o("code",[e._v("microtask queue")]),e._v("。"),o("code",[e._v("microtask")]),e._v("是一种要排入"),o("RouterLink",{attrs:{to:"hhttps://www.w3.org/TR/html5/webappapis.html#microtask-queue"}},[o("code",[e._v("microtask queue")])]),e._v("的而不是"),o("code",[e._v("task queue")]),e._v("的任务。有两种"),o("a",{attrs:{href:"https://www.w3.org/TR/html5/webappapis.html#microtask",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("microtasks")]),o("OutboundLink")],1),e._v("："),o("code",[e._v("solitary callback microtasks")]),e._v("和 "),o("code",[e._v("compound microtasks")]),e._v("。")],1)]),e._v(" "),o("p",[e._v("规范只介绍了"),o("a",{attrs:{href:"https://www.w3.org/TR/html5/webappapis.html#solitary-callback-microtasks",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("solitary callback microtasks")]),o("OutboundLink")],1),e._v("，"),o("code",[e._v("compound microtasks")]),e._v(" 可以先忽略掉。")]),e._v(" "),o("blockquote",[o("p",[e._v("当一个"),o("code",[e._v("microtask")]),e._v("要被排入的时候，它必须被排入相关 "),o("code",[e._v("event loop")]),e._v("的"),o("code",[e._v("microtask queue，microtask")]),e._v("的"),o("code",[e._v("task source")]),e._v("是"),o("code",[e._v("microtask task source")]),e._v(".")])]),e._v(" "),o("h3",{attrs:{id:"microtasks检查点"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#microtasks检查点"}},[e._v("#")]),e._v(" "),o("code",[e._v("microtasks")]),e._v("检查点")]),e._v(" "),o("p",[e._v("当用户代理执行到了"),o("code",[e._v("microtasks")]),e._v("检查点的时候，如果"),o("a",{attrs:{href:"https://www.w3.org/TR/html5/webappapis.html#performing-a-microtask-checkpoint-flag",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("performing a microtask checkpoint flag")]),e._v(" "),o("OutboundLink")],1),e._v("为 "),o("code",[e._v("false")]),e._v("，则用户代理必须运行下面的步骤：")]),e._v(" "),o("ol",[o("li",[e._v("将"),o("code",[e._v("performing a microtask checkpoint flag")]),e._v("置为"),o("code",[e._v("true")]),e._v("。")]),e._v(" "),o("li",[e._v("处理"),o("code",[e._v("microtask queue")]),e._v("：如果"),o("code",[e._v("event loop")]),e._v("的 "),o("code",[e._v("microtask queue")]),e._v("是空的，直接跳到"),o("code",[e._v("Done")]),e._v("步。")]),e._v(" "),o("li",[e._v("选择"),o("code",[e._v("event loop")]),e._v("的"),o("code",[e._v("microtask queue")]),e._v("中最老的 "),o("code",[e._v("microtask")]),e._v("。")]),e._v(" "),o("li",[e._v("设定"),o("code",[e._v("event loop")]),e._v("当前执行的"),o("code",[e._v("task")]),e._v("为上一步中选择的 "),o("code",[e._v("task")]),e._v("。")]),e._v(" "),o("li",[e._v("执行：执行选中的"),o("code",[e._v("task")]),e._v("。")])]),e._v(" "),o("blockquote",[o("p",[e._v("注意：这有可能涉及相关的脚本回调函数，这些回调函数最后都会执行"),o("a",{attrs:{href:"https://www.w3.org/TR/html5/webappapis.html#clean-up-after-running-script",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("clean up after running script")]),e._v(" "),o("OutboundLink")],1),e._v("，这回导致再次"),o("a",{attrs:{href:"https://www.w3.org/TR/html5/webappapis.html#performs-a-microtask-checkpoint",target:"_blank",rel:"noopener noreferrer"}},[e._v("执行"),o("code",[e._v("microtask")]),e._v(" 检查点的任务"),o("OutboundLink")],1),e._v("，这就是我们要使用 "),o("code",[e._v("performing a microtask checkpoint flag")]),e._v("的原因。")])]),e._v(" "),o("ol",{attrs:{start:"6"}},[o("li",[e._v("将"),o("code",[e._v("event loop")]),e._v("的当前执行"),o("code",[e._v("task")]),e._v("设为"),o("code",[e._v("null")]),e._v("。")]),e._v(" "),o("li",[e._v("将上一步中执行的"),o("code",[e._v("microtask")]),e._v("从"),o("code",[e._v("microtask queue")]),e._v(" 中移除，然后返回 处理"),o("code",[e._v("microtask queue")]),e._v("步骤。")]),e._v(" "),o("li",[e._v("完成： 对每一个"),o("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("responsible event loop")]),e._v(" "),o("OutboundLink")],1),e._v("就是当前的"),o("code",[e._v("event loop")]),e._v("的"),o("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("environment settings object")]),o("OutboundLink")],1),e._v("，给"),o("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("environment settings object")]),e._v(" "),o("OutboundLink")],1),e._v("发一个"),o("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#notify-about-rejected-promises",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("rejected promises")]),o("OutboundLink")],1),e._v("的通知。")]),e._v(" "),o("li",[o("a",{attrs:{href:"https://w3c.github.io/IndexedDB/#cleanup-indexed-database-transactions",target:"_blank",rel:"noopener noreferrer"}},[e._v("清理"),o("code",[e._v("IndexedDB")]),e._v(" 的事务"),o("OutboundLink")],1),e._v("。")]),e._v(" "),o("li",[e._v("将"),o("code",[e._v("performing a microtask checkpoint flag")]),e._v("设为 "),o("code",[e._v("false")]),e._v("。")])]),e._v(" "),o("p",[e._v("为啥要用"),o("code",[e._v("microtask")]),e._v("？根据"),o("code",[e._v("HTML Standard")]),e._v("，在每个 "),o("code",[e._v("task")]),e._v("运行完以后，"),o("code",[e._v("UI")]),e._v("都会重渲染，那么在"),o("code",[e._v("microtask")]),e._v(" 中就完成数据更新，当前"),o("code",[e._v("task")]),e._v("结束就可以得到最新的"),o("code",[e._v("UI")]),e._v("了。反之如果新建一个"),o("code",[e._v("task")]),e._v(" 来做数据更新，那么渲染就会进行两次。")]),e._v(" "),o("p",[e._v("整个流程如下图：")]),e._v(" "),o("p",[o("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/7/25/164d18380a1dccc6?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"image"}})]),e._v(" "),o("h3",{attrs:{id:"task-microtask"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#task-microtask"}},[e._v("#")]),e._v(" "),o("code",[e._v("task & microTask")])]),e._v(" "),o("p",[o("code",[e._v("task")]),e._v("主要包含：")]),e._v(" "),o("ul",[o("li",[o("code",[e._v("script")]),e._v("（整体代码）")]),e._v(" "),o("li",[o("code",[e._v("setTimeout")])]),e._v(" "),o("li",[o("code",[e._v("setInterval")])]),e._v(" "),o("li",[o("code",[e._v("setImmediate")])]),e._v(" "),o("li",[o("code",[e._v("I/O")])]),e._v(" "),o("li",[o("code",[e._v("UI rendering")])])]),e._v(" "),o("p",[o("code",[e._v("microtask")]),e._v("主要包含：")]),e._v(" "),o("ul",[o("li",[o("code",[e._v("process.nextTick")]),e._v("（"),o("code",[e._v("Node.js")]),e._v("环境）")]),e._v(" "),o("li",[o("code",[e._v("Promises")]),e._v("（这里指浏览器实现的原生"),o("code",[e._v("Promise")]),e._v("）")]),e._v(" "),o("li",[o("code",[e._v("Object.observe")]),e._v("（已被"),o("code",[e._v("MutationObserver")]),e._v("替代）")]),e._v(" "),o("li",[o("code",[e._v("MutationObserver")])]),e._v(" "),o("li",[o("code",[e._v("postMessage")])])]),e._v(" "),o("h3",{attrs:{id:"web-apis"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#web-apis"}},[e._v("#")]),e._v(" "),o("code",[e._v("Web APIs")])]),e._v(" "),o("p",[e._v("在上面讲到了用户代理（宿主环境/运行环境/浏览器）来控制任务的调度，"),o("code",[e._v("task queues")]),e._v(" 只是一个队列，它并不知道什么时候有新的任务推入，也不知道什么时候任务出队。"),o("code",[e._v("event loop")]),e._v(" 会根据规则不断将任务出队，那谁来将任务入队呢？答案是 "),o("code",[e._v("Web APIs")]),e._v("。\n我们都知道"),o("code",[e._v("JavaScript")]),e._v(" 的执行是单线程的，但是浏览器并不是单线程的，"),o("code",[e._v("Web APIs")]),e._v("就是一些额外的线程，它们通常由"),o("code",[e._v("C++")]),e._v(" 来实现，用来处理非同步事件比如"),o("code",[e._v("DOM")]),e._v("事件，"),o("code",[e._v("http")]),e._v(" 请求，"),o("code",[e._v("setTimeout")]),e._v("等。他们是浏览器实现并发的入口，对于"),o("code",[e._v("Node.JavaScript")]),e._v("来说，就是一些"),o("code",[e._v("C++")]),e._v("的"),o("code",[e._v("APIs")]),e._v("。")]),e._v(" "),o("blockquote",[o("p",[o("code",[e._v("WebAPIs")]),e._v("本身并不能直接将回调函数放在函数调用栈中来执行，否则它会随机在整个程序的运行过程中出现。每个 "),o("code",[e._v("WebAPIs")]),e._v("会在其执行完毕的时候将回调函数推入到对应的任务队列中，然后由"),o("code",[e._v("event loop")]),e._v(" 按照规则在函数调用栈为空的时候将回调函数推入执行栈中执行。"),o("code",[e._v("event loop")]),e._v(" 的基本作用就是检查函数调用栈和任务队列，并在函数调用栈为空时将任务队列中的的第一个任务推入执行栈中，每一个任务都在下一个任务执行前执行完毕。")])]),e._v(" "),o("p",[o("code",[e._v("WebAPIs")]),e._v("提供了多线程来执行异步函数，在回调发生的时候，它们会将回调函数和推入任务队列中并传递返回值。")]),e._v(" "),o("h3",{attrs:{id:"参考文献"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[e._v("#")]),e._v(" 参考文献")]),e._v(" "),o("p",[o("a",{attrs:{href:"https://www.w3.org/TR/html5/webappapis.html#event-loops-definitions",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("HTML5")]),e._v("规范"),o("OutboundLink")],1)]),e._v(" "),o("p",[o("a",{attrs:{href:"https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Tasks, microtasks, queues and schedules"),o("OutboundLink")],1)]),e._v(" "),o("p",[o("a",{attrs:{href:"https://juejin.im/post/5b5873a1e51d4519133fbc35",target:"_blank",rel:"noopener noreferrer"}},[e._v("跟着"),o("code",[e._v("Event loop")]),e._v(" 规范理解浏览器中的异步机制"),o("OutboundLink")],1)]),e._v(" "),o("p",[o("a",{attrs:{href:"https://www.zhihu.com/question/55364497/answer/144215284",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("Vue")]),e._v("中如何使用"),o("code",[e._v("MutationObserver")]),e._v(" 做批量处理？"),o("OutboundLink")],1)])])}),[],!1,null,null,null);o.default=_.exports}}]);